<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>계좌이체</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .quill-container {
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            overflow: hidden;
            background-color: #ffffff;
        }
        .ql-toolbar.ql-snow {
            border-bottom: 1px solid #d1d5db;
        }
        .ql-container.ql-snow {
            border: none;
            height: 150px;
        }
    </style>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
</head>
<body>
    <div id="app" class="flex flex-col items-center justify-center min-h-screen p-4">
        
        <div class="bg-white p-8 rounded-2xl shadow-lg w-full max-w-lg">
            <div class="mb-8 flex justify-center">
               <h1
                   class="text-6xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500 animate-pulse drop-shadow-xl">
                    <a href="main.html">원정은행</a></h1>
            </div>
            <hr class="my-6">
            <h1 class="text-3xl font-bold text-gray-800 text-center mb-6">이체하기</h1>
            
            <div class="space-y-4">
                <div class="mb-4">
                    <label class="block text-gray-700 font-semibold mb-1">
                        받는이 계좌번호
                    </label>
                    <input type="text" v-model="toAccount" placeholder="계좌번호를 입력하세요"
                        class="w-full px-4 py-2 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
                </div>
                
                <div class="mb-4">
                    <label class="block text-gray-700 font-semibold mb-1">
                        이체 금액
                    </label>
                    <input type="text" v-model="formattedAmount" placeholder="금액을 입력하세요"
                        class="w-full px-4 py-2 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
                </div>
                
                <div class="mb-6">
                    <label class="block text-gray-700 font-semibold mb-1">
                        메모 작성
                    </label>
                    <div id="editor" class="quill-container"></div>
                </div>
            </div>

            <div class="flex justify-center space-x-4 my-6">
                <button @click="fnTransfer"
                    class="px-6 py-3 bg-indigo-600 text-white font-semibold rounded-full shadow-lg hover:bg-indigo-700 transition duration-300 ease-in-out">
                    실행
                </button>
                <button @click="fnCancel"
                    class="px-6 py-3 bg-gray-500 text-white font-semibold rounded-full shadow-lg hover:bg-gray-600 transition duration-300 ease-in-out">
                    취소
                </button>
            </div>
        </div>

        <!-- 성공 메시지 모달 -->
        <div v-if="successMessage" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4">
            <div class="bg-white p-6 rounded-lg shadow-xl text-center">
                <p class="text-lg font-bold text-gray-800 mb-4">{{ successMessage }}</p>
                <button @click="hideSuccessMessage" class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-full">확인</button>
            </div>
        </div>
    </div>
</body>
</html>

<script>
    const app = Vue.createApp({
        data() {
            return {
                amount: null,
                memo: "",
                accountNo: "",
                toAccount: "",
                successMessage: ""
            };
        },
        computed: {
            formattedAmount: {
                get() {
                    if (this.amount === null) {
                        return '';
                    }
                    return new Intl.NumberFormat('ko-KR').format(this.amount);
                },
                set(value) {
                    const parsed = parseInt(value.replace(/,/g, ''), 10);
                    this.amount = isNaN(parsed) ? null : parsed;
                }
            }
        },
        methods: {
            // 이체 실행 함수
            fnTransfer: function () {
                let self = this;
                if (!self.toAccount || !self.amount || self.amount <= 0) {
                    // `alert()` 대신 모달 메시지를 사용하도록 변경
                    self.successMessage = "받는이 계좌번호와 올바른 금액을 입력해주세요.";
                    return;
                }

                let param = {
                    accountNo: self.accountNo,
                    toAccount: self.toAccount,
                    amount: self.amount,
                    memo: self.memo
                };
                
                $.ajax({
                    url: "http://localhost:3009/deposit/transfer",
                    dataType: "json",
                    type: "GET",
                    data: param,
                    success: function (data) {
                        self.successMessage = "이체가 성공적으로 완료되었습니다.";
                    },
                    error: function(xhr, status, error) {
                        console.error("Error during transfer:", error);
                        self.successMessage = "이체 중 오류가 발생했습니다. 다시 시도해주세요.";
                    }
                });
            },
            // 취소 함수 (이전 페이지로 돌아가기)
            fnCancel: function () {
                history.back();
            },
            // 성공 메시지 숨기고 페이지 이동
            hideSuccessMessage: function() {
                this.successMessage = "";
                location.href = `account-view.html?accountNo=${this.accountNo}`;
            }
        },
        mounted() {
            let self = this;
            // URL 파라미터에서 계좌번호 가져오기
            const urlParams = new URLSearchParams(window.location.search);
            self.accountNo = urlParams.get('accountNo') || "";

            // Quill 에디터 초기화
            const quill = new Quill('#editor', {
                theme: 'snow',
                modules: {
                    toolbar: [
                        [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
                        ['bold', 'italic', 'underline'],
                        [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                        ['link', 'image'],
                        ['clean'],
                    ],
                },
            });

            // 에디터 내용이 변경될 때마다 Vue 데이터를 업데이트
            quill.on('text-change', function () {
                self.memo = quill.root.innerHTML;
            });
        }
    });

    app.mount('#app');
</script>
